# Triggers on google calendar event to take Cimzia
- id: take_cimzia
  alias: Take Cimzia
  initial_state: on
  trigger:
    platform: state
    entity_id: calendar.cimzia
    to: 'on'
  action: 
    - service: !secret telservice
      data_template:
        message: "Did you take your Cimzia?"
        data:
          inline_keyboard: 'Yes:/cimziaoff,Warming it up now:/cimziawarmup'
    - service: timer.start
      data:
        entity_id: timer.cimzia
        duration: '00:30:00'

# Handle the telegram response for yes
- id: cimzia_off
  alias: Cimzia Taken
  initial_state: on
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: '/cimziaoff'
  action:
    - service: telegram_bot.answer_callback_query
      data_template:
        callback_query_id: '{{ trigger.event.data.id }}'
        message: 'Ok, Cimzia reminder acknowledged'
    - service: telegram_bot.edit_replymarkup
      data_template:
        message_id: '{{ trigger.event.data.message.message_id }}'
        chat_id: '{{ trigger.event.data.user_id }}'
        inline_keyboard: []
    - service: timer.cancel
      entity_id: timer.cimzia

# Handle the telegram response for warming up
- id: cimzia_warming_up
  alias: Cimzia Warming Up
  initial_state: on
  trigger:
    platform: event
    event_type: telegram_callback
    event_data:
      data: '/cimziawarmup'
  action:
    - service: telegram_bot.answer_callback_query
      data_template:
        callback_query_id: '{{ trigger.event.data.id }}'
        message: 'Ok, I will remind you again in 30 minutes.'
    - service: telegram_bot.edit_replymarkup
      data_template:
        message_id: '{{ trigger.event.data.message.message_id }}'
        chat_id: '{{ trigger.event.data.user_id }}'
        inline_keyboard: []
    - service: timer.cancel
      entity_id: timer.cimzia
    - service: timer.start
      data:        
        entity_id: timer.cimzia
        duration: '00:30:00'


# Fire the notification again if the timer finishes
- id: repeat_take_cimzia
  alias: Repeat Take Cimzia
  initial_state: on
  trigger:
    platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.cimzia
  action:
    - service: !secret telservice
      data_template:
        message: "Did you take your Cimzia?"
        data:
            inline_keyboard: 'Yes:/cimziaoff'
    - service: timer.start
      data:
        entity_id: timer.cimzia
        duration: '00:30:00'
