- id: front_porch_snapshot
  alias: Front Porch Camera Snapshot
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.front_porch
    to: 'on'
  action:
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch
    - delay: '00:00:05'
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch

- id: reset_tensorflow
  alias: Reset Tensorflow State
  initial_state: on
  trigger:
    platform: state
    entity_id: sensor.front_porch
    to: 'off'
  action:
    - service: image_processing.scan
      entity_id: image_processing.tensorflow_front_porch

- id: front_porch_person_detected
  alias: Person Detected on Front Porch
  initial_state: on
  trigger:
    platform: state
    entity_id: image_processing.tensorflow_front_porch
    from: '0'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: input_boolean.guest
        state: 'off'
      - condition: state
        entity_id: input_boolean.doorbell
        state: 'on'
      - condition: state
        entity_id: input_boolean.autolock
        state: 'on'
      - condition: state
        entity_id: binary_sensor.front_door
        state: 'off'
      - condition: template
        value_template: "{{ not (now() - states.binary_sensor.front_door.last_changed).total_seconds() < 30 }}"
  action:
    - service: !secret telservice
      data:
        message: "Person detected on the front porch"
        data:
          photo:
            - file: "/tmp/front_porch.jpg"
    - service: script.turn_on
      entity_id: script.doorbell
